# next-swarm.ps1 - Phase 7 -> Phase 8 Transition
# Generated by Claude-4 (Polish/Review)
#
# Phase 7 Final State:
#   - Backend: 276 tests passing (26 test files)
#   - Frontend: 227 tests passing (11 test files)
#   - Total: 503 tests, zero new failures (2 pre-existing flaky tests on host paths)
#   - New API: POST /api/swarm/input (stdin to running swarm)
#   - New API: GET /api/logs/search with from_date/to_date date range filtering
#   - Auth: Optional API key via LU_API_KEY env var (Bearer/X-API-Key, hmac.compare_digest)
#   - DB: 3 indexes on projects.status, swarm_runs(project_id, started_at), swarm_runs.status
#   - Frontend: Terminal input bar, AuthModal, date range picker, LIVE indicator, keyboard shortcuts
#   - Frontend: Shared constants (lib/constants.js), useMemo optimization, aria-labels throughout
#   - Hardening: Field(ge=1) on all project_id params, _swarm_processes cleanup, client-side validation
#   - Incremental log streaming: file position tracking in watcher.py (no re-read, only new lines)
#
# Phase 8 Focus: Process Management, Templates, Performance & UX Polish
#   - Template system for reusable swarm configurations
#   - Process reconnection after server restart
#   - Sparkline graphs for dashboard metrics
#   - Fix flaky tests (hardcoded fixture paths)
#   - Frontend performance: virtualized log rendering, debounced search
#   - Production polish: error boundaries, loading states, empty states
#   - All agents: web research + skill discovery baked into swarm.ps1 prompts (auto-applied every phase)

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "  Phase 7 Complete -> Launching Phase 8" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "  Phase 7: Stdin, Auth, Indexes, Date Range, Shortcuts - DONE" -ForegroundColor Green
Write-Host "  503 tests passing (276 backend + 227 frontend)" -ForegroundColor Green
Write-Host ""
Write-Host "  Phase 8: Templates, Reconnection, Sparklines, Polish" -ForegroundColor Yellow
Write-Host ""

# Generate Phase 8 task board
$phase8Tasks = @"
# Latent Underground - Task Board (Phase 8)

## Claude-1 [Backend/Core] - Templates CRUD, process reconnection, performance

- [ ] Add swarm templates CRUD: POST/GET/PATCH/DELETE /api/templates with name, description, config JSON
- [ ] Add process reconnection on restart: store PID+folder in DB, attempt to reattach stdout/stderr pipes on startup (if process still alive)
- [ ] Add swarm output pagination: GET /api/swarm/output/{id}?offset=&limit= with proper capping
- [ ] Fix flaky tests: Replace hardcoded "F:/TestProject" in sample_project_data with tmp_path
- [ ] Add rate limiting: configurable requests-per-minute on POST endpoints (prevent accidental rapid launches)
- [ ] Signal: Create .claude/signals/backend-ready.signal

## Claude-2 [Frontend/Interface] - Templates UI, sparklines, performance polish

- [ ] Add template selector: dropdown in NewProject to apply saved configs, template management page
- [ ] Add sparkline graphs in Dashboard: task completion trend, run duration trend (lightweight SVG)
- [ ] Add virtualized log rendering: react-window or virtual scroll for 1000+ lines in LogViewer
- [ ] Add debounced search: 300ms debounce on search text input in LogViewer and Sidebar
- [ ] Improve loading states: skeleton placeholders while data loads, smooth transitions
- [ ] Signal: Create .claude/signals/frontend-ready.signal

## Claude-3 [Integration/Testing] - Test coverage for Phase 8 features

- [ ] Add tests for templates CRUD API (create, list, get, update, delete, not found)
- [ ] Add tests for process reconnection (alive PID reattach, dead PID cleanup)
- [ ] Add tests for swarm output pagination (offset, limit, empty buffer)
- [ ] Fix flaky tests: Migrate all test fixtures from hardcoded paths to tmp_path
- [ ] Add frontend tests for template selector, sparklines, virtualized log
- [ ] Signal: Create .claude/signals/tests-passing.signal

## Claude-4 [Polish/Review] - Final quality gate

- [ ] Review all Phase 8 code changes for quality and consistency
- [ ] Verify no regressions: all Phase 7 tests still pass (503+)
- [ ] Accessibility review: keyboard nav, screen reader support, ARIA on new components
- [ ] Performance profiling: measure render times for large log files, API response times
- [ ] FINAL: Generate next-swarm.ps1 for Phase 9 or mark project production-ready

## Completion Criteria
- [ ] Swarm templates can be created, saved, and applied to new projects
- [ ] Server restart reconnects to running swarm processes (no orphaned processes)
- [ ] Dashboard shows sparkline trend graphs for key metrics
- [ ] Log viewer handles 1000+ lines without UI lag
- [ ] All tests pass (backend + frontend), zero flaky tests
"@

$phase8Tasks | Out-File -FilePath "tasks/TASKS.md" -Encoding UTF8
Write-Host "  Generated new tasks/TASKS.md for Phase 8" -ForegroundColor Green
Write-Host ""

# Relaunch swarm
Write-Host "  Relaunching swarm for Phase 8..." -ForegroundColor Yellow
& .\swarm.ps1 -Resume -NoConfirm -MaxPhases 24
